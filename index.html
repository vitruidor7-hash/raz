<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raz's Field Journal - Cloud Synced</title>
    <!-- Standard Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&amp;family=Fredoka:wght@400;600&amp;display=swap" rel="stylesheet">
    
    <style id="app-styles">
        :root {
            --psy-purple: #2D1E2F;
            --psy-green: #A9D046;
            --psy-orange: #F58F29;
            --psy-blue: #48ACF0;
            --psy-pink: #E84855;
            --psy-yellow: #FFD700;
            --psy-teal: #2EC4B6;
        }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--psy-purple);
            background-image: radial-gradient(circle at 20% 20%, rgba(72, 172, 240, 0.15) 0%, transparent 20%),
                              radial-gradient(circle at 80% 80%, rgba(169, 208, 70, 0.15) 0%, transparent 20%);
            color: white;
            overflow-x: hidden;
        }

        h1, h2, h3, .psy-font {
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a111b; 
        }
        ::-webkit-scrollbar-thumb {
            background: var(--psy-green); 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--psy-orange); 
        }

        .skew-card {
            transform: perspective(1000px) rotateY(2deg) rotateZ(-1deg);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .skew-card:hover {
            transform: perspective(1000px) rotateY(0deg) rotateZ(0deg) scale(1.02);
            z-index: 10;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .rank-badge {
            background: conic-gradient(from 0deg, var(--psy-orange), var(--psy-yellow), var(--psy-green), var(--psy-blue), var(--psy-purple), var(--psy-orange));
            animation: spin 10s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pin-card {
            transition: all 0.2s ease;
            filter: grayscale(100%) opacity(0.6);
        }
        .pin-card.owned {
            filter: grayscale(0%) opacity(1);
            border-color: var(--psy-yellow);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        .pin-card:hover {
            transform: scale(1.05);
        }

        /* Menu Styles */
        .menu-btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .menu-btn:hover {
            transform: scale(1.05) rotate(-2deg);
            box-shadow: 0 0 20px var(--hover-color);
            border-color: white;
        }
        .menu-btn.no-wobble:hover {
            transform: scale(1.02) rotate(0deg); 
        }
        .menu-bg-overlay {
            background: radial-gradient(circle at center, transparent 0%, #2D1E2F 90%);
        }

        /* CRT Effect for Ottomatic */
        .ottomatic-screen {
            background: radial-gradient(circle, #2a2a2a 0%, #000 100%);
            border: 8px solid #444;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }
        .ottomatic-screen::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* CUSTOM RANGE SLIDER STYLING */
        /* This makes the input look like a progress bar but remain clickable */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }
        input[type=range]:focus {
            outline: none;
        }
        
        /* The Thumb (Handle) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid var(--thumb-color, #ccc);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-top: -8px; /* center it */
        }
        
        /* The Track (Background) */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 10px;
            cursor: pointer;
            background: #374151; /* Gray-700 */
            border-radius: 5px;
        }
        
        /* Firefox Styles */
        input[type=range]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border: 2px solid var(--thumb-color, #ccc);
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 10px;
            cursor: pointer;
            background: #374151;
            border-radius: 5px;
        }

        /* Code Block */
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid #333;
            white-space: pre;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Loading Screen -->
<div id="loader" class="fixed inset-0 bg-[#2D1E2F] z-[100] flex flex-col items-center justify-center">
    <div class="relative w-24 h-24">
        <div class="absolute inset-0 rounded-full border-4 border-green-500 border-t-transparent animate-spin"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <span class="material-symbols-outlined text-4xl text-green-400 animate-pulse">psychology</span>
        </div>
    </div>
    <h2 class="mt-4 text-xl text-green-400 psy-font tracking-widest">Establishing Psychic Link...</h2>
    <p class="text-sm text-gray-500" id="auth-status">Authenticating...</p>
</div>

<!-- Header (Restored Original) -->
<header class="glass-panel sticky top-0 z-50 px-4 py-3 shadow-lg border-b-4 border-green-500">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
        <!-- Logo Area -->
        <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('menu')">
            <div class="relative w-12 h-12 rounded-full overflow-hidden border-2 border-white shadow-lg bg-green-500 flex items-center justify-center hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-3xl text-white">psychology</span>
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl text-white drop-shadow-md">Raz's Field Journal</h1>
                <p class="text-xs md:text-sm text-green-300 font-bold tracking-wider uppercase">Universal Cloud Sync</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Back Button (Restored) -->
            <button id="back-btn" onclick="switchTab('menu')" class="hidden px-4 py-2 bg-red-500 hover:bg-red-400 text-white rounded-full font-bold shadow-lg border-2 border-red-300 transition-all flex items-center gap-2">
                <span class="material-symbols-outlined">arrow_back</span>
                <span class="hidden sm:inline">Back to Mind</span>
            </button>

            <!-- Rank & Global Stats -->
            <div class="flex items-center gap-4 bg-gray-900/80 rounded-full pr-6 pl-2 py-2 border border-gray-700 shadow-inner">
                <div class="relative w-12 h-12">
                    <div class="absolute inset-0 rounded-full rank-badge blur-sm opacity-75"></div>
                    <div class="absolute inset-0 rounded-full bg-gray-800 flex items-center justify-center border-2 border-yellow-400 z-10">
                        <span class="text-yellow-400 font-bold text-xl psy-font" id="current-rank">1</span>
                    </div>
                </div>
                <div class="flex flex-col items-start hidden sm:flex">
                    <div class="text-xs text-gray-400 uppercase tracking-wider">Current Rank</div>
                    <div class="text-sm font-bold text-yellow-400 leading-none" id="rank-title">Intern</div>
                </div>
                <div class="h-8 w-px bg-gray-700 mx-2 hidden sm:block"></div>
                <div class="flex flex-col items-end min-w-[60px]">
                    <div class="text-xs text-gray-400 uppercase tracking-wider">Total</div>
                    <div class="text-xl font-bold text-green-400 leading-none psy-font" id="global-percent">0%</div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full relative">

    <!-- MAIN MENU (Default View) -->
    <section id="view-menu" class="absolute inset-0 z-40 flex items-center justify-center p-4">
        <!-- Background Image Layer -->
        <div class="absolute inset-0 z-0 overflow-hidden">
            <img src="Images/Menu_Background.png" onerror="this.style.display='none'" class="w-full h-full object-cover opacity-40 animate-pulse-slow">
            <!-- CSS Fallback Gradient if image missing -->
            <div class="absolute inset-0 bg-gradient-to-br from-purple-900 via-gray-900 to-black -z-10"></div>
            <div class="absolute inset-0 menu-bg-overlay"></div>
        </div>

        <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl w-full">
            <!-- Mental Worlds Button -->
            <button onclick="switchTab('mental')" class="menu-btn group relative h-40 md:h-56 rounded-3xl bg-gray-800/80 border-4 border-pink-500 hover:bg-pink-900/80 flex flex-col items-center justify-center overflow-hidden" style="--hover-color: rgba(232, 85, 85, 0.5)">
                <div class="absolute inset-0 bg-[url('Images/Menu_Icon_Mental.png')] bg-cover bg-center opacity-30 group-hover:opacity-50 transition-opacity duration-500"></div>
                <span class="material-symbols-outlined text-6xl text-pink-400 mb-2 group-hover:scale-110 transition-transform z-10 drop-shadow-lg">psychology_alt</span>
                <h2 class="text-3xl md:text-4xl text-white psy-font tracking-wider drop-shadow-lg z-10">Mental Worlds</h2>
                <p class="text-pink-300 font-bold uppercase tracking-widest text-sm z-10">Explore The Mind</p>
            </button>

            <!-- Hub Worlds Button -->
            <button onclick="switchTab('hubs')" class="menu-btn group relative h-40 md:h-56 rounded-3xl bg-gray-800/80 border-4 border-green-500 hover:bg-green-900/80 flex flex-col items-center justify-center overflow-hidden" style="--hover-color: rgba(169, 208, 70, 0.5)">
                <div class="absolute inset-0 bg-[url('Images/Menu_Icon_Real.png')] bg-cover bg-center opacity-30 group-hover:opacity-50 transition-opacity duration-500"></div>
                <span class="material-symbols-outlined text-6xl text-green-400 mb-2 group-hover:scale-110 transition-transform z-10 drop-shadow-lg">public</span>
                <h2 class="text-3xl md:text-4xl text-white psy-font tracking-wider drop-shadow-lg z-10">Real World</h2>
                <p class="text-green-300 font-bold uppercase tracking-widest text-sm z-10">Explore The Camp</p>
            </button>

            <!-- Missions Button -->
            <button onclick="switchTab('missions')" class="menu-btn group relative h-40 md:h-56 rounded-3xl bg-gray-800/80 border-4 border-blue-500 hover:bg-blue-900/80 flex flex-col items-center justify-center overflow-hidden" style="--hover-color: rgba(72, 172, 240, 0.5)">
                <div class="absolute inset-0 bg-[url('Images/Menu_Icon_Mission.png')] bg-cover bg-center opacity-30 group-hover:opacity-50 transition-opacity duration-500"></div>
                <span class="material-symbols-outlined text-6xl text-blue-400 mb-2 group-hover:scale-110 transition-transform z-10 drop-shadow-lg">assignment_late</span>
                <h2 class="text-3xl md:text-4xl text-white psy-font tracking-wider drop-shadow-lg z-10">Mission Log</h2>
                <p class="text-blue-300 font-bold uppercase tracking-widest text-sm z-10">Scavenger Hunt & Tasks</p>
            </button>

            <!-- Ottomatic Button -->
            <button onclick="switchTab('ottomatic')" class="menu-btn group relative h-40 md:h-56 rounded-3xl bg-gray-800/80 border-4 border-yellow-500 hover:bg-yellow-900/80 flex flex-col items-center justify-center overflow-hidden" style="--hover-color: rgba(255, 215, 0, 0.5)">
                <div class="absolute inset-0 bg-[url('Images/Menu_Icon_Otto.png')] bg-cover bg-center opacity-30 group-hover:opacity-50 transition-opacity duration-500"></div>
                <span class="material-symbols-outlined text-6xl text-yellow-400 mb-2 group-hover:scale-110 transition-transform z-10 drop-shadow-lg">shopping_cart</span>
                <h2 class="text-3xl md:text-4xl text-white psy-font tracking-wider drop-shadow-lg z-10">The Ottomatic</h2>
                <p class="text-yellow-300 font-bold uppercase tracking-widest text-sm z-10">Buy Pins & Items</p>
            </button>
            
            <!-- Code Button (Small & Non-Wobbling) -->
            <button onclick="switchTab('code')" class="md:col-span-2 menu-btn no-wobble group h-16 rounded-2xl bg-gray-900/50 border-2 border-gray-600 hover:border-white flex items-center justify-center gap-2 text-gray-400 hover:text-white" style="--hover-color: rgba(255, 255, 255, 0.2)">
                <span class="material-symbols-outlined">code</span>
                <span class="font-bold">View Source Code</span>
            </button>
        </div>
    </section>

    <!-- View 1: Mental Worlds -->
    <section id="view-mental" class="space-y-6 hidden animate-fade-in">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-12" id="mental-grid">
            <!-- Populated by JS -->
        </div>
    </section>

    <!-- View 2: Hub Worlds -->
    <section id="view-hubs" class="hidden space-y-6 animate-fade-in">
        <div class="bg-blue-900/30 border border-blue-500/30 rounded-2xl p-6 mb-8 text-center">
            <h2 class="text-2xl text-blue-300 mb-2">Real World Exploration</h2>
            <p class="text-gray-400 max-w-2xl mx-auto">Explore the Motherlobe and surrounding areas. Collect all PSI Cards, Supply Chests, and Challenge Markers to hit Rank 102.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="hubs-grid">
             <!-- Populated by JS -->
        </div>
    </section>

    <!-- View 3: Mission Log -->
    <section id="view-missions" class="hidden max-w-5xl mx-auto grid md:grid-cols-2 gap-8 animate-fade-in">
        <!-- Scavenger Hunt -->
        <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700 md:col-span-2 lg:col-span-1">
            <div class="relative h-48 bg-yellow-900/20 overflow-hidden">
                <div class="w-full h-full bg-gradient-to-br from-yellow-900 to-yellow-700 flex items-center justify-center opacity-50">
                    <span class="material-symbols-outlined text-9xl text-white/10 transform rotate-12">checklist</span>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-gray-800 to-transparent"></div>
                <div class="absolute bottom-4 left-6">
                    <h2 class="text-3xl text-yellow-400 psy-font drop-shadow-md">Scavenger Hunt</h2>
                    <p class="text-gray-300 text-sm font-bold uppercase">Mission Critical Assets</p>
                </div>
                <div class="absolute top-4 right-4 bg-black/50 px-3 py-1 rounded-full text-yellow-400 font-bold" id="scavenger-progress">0/16</div>
            </div>
            <div id="scavenger-list" class="p-4 md:p-6 grid grid-cols-1 gap-2 max-h-[600px] overflow-y-auto custom-scrollbar">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Side Quests List -->
        <div class="md:col-span-2 lg:col-span-1 space-y-8">
            <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700">
                <div class="p-6 border-b border-gray-700 bg-purple-900/20">
                    <h2 class="text-2xl text-purple-400 psy-font">Side Assignments</h2>
                    <p class="text-xs text-gray-400">Required for 100% completion</p>
                </div>
                <div id="side-quests-list" class="p-6 space-y-6">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Misc Tasks -->
            <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700">
                <div class="p-6 border-b border-gray-700 bg-blue-900/20">
                    <h2 class="text-2xl text-blue-400 psy-font">Field Tasks</h2>
                    <p class="text-xs text-gray-400">Mini-games &amp; Achievements</p>
                </div>
                <div id="misc-tasks-list" class="p-6 space-y-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </section>

    <!-- View 4: The Ottomatic -->
    <section id="view-ottomatic" class="hidden w-full max-w-6xl mx-auto animate-fade-in">
        <div class="ottomatic-screen rounded-3xl p-6 md:p-10 min-h-[80vh]">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-2 border-white/10 pb-4">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full border-2 border-yellow-400 bg-gray-800 flex items-center justify-center overflow-hidden">
                         <span class="material-symbols-outlined text-4xl text-yellow-400">smart_toy</span>
                    </div>
                    <div>
                        <h2 class="text-4xl text-yellow-400 psy-font tracking-widest">THE OTTO-MATIC</h2>
                        <p class="text-green-400 font-mono text-sm"> &gt; WELCOME AGENT. SPEND YOUR PSITANIUM.</p>
                    </div>
                </div>
                <div class="bg-black/50 px-6 py-3 rounded-lg border border-green-500/30 text-right">
                    <div class="text-xs text-gray-400 font-mono uppercase">Pins Collected</div>
                    <div class="text-3xl text-white font-mono" id="pins-collected-count">0/33</div>
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="px-4 py-1 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/50 text-sm font-bold hover:bg-yellow-500/40" onclick="filterPins('all')">ALL</button>
                <button class="px-4 py-1 rounded-full bg-purple-500/20 text-purple-300 border border-purple-500/50 text-sm font-bold hover:bg-purple-500/40" onclick="filterPins('Utility')">UTILITY</button>
                <button class="px-4 py-1 rounded-full bg-red-500/20 text-red-300 border border-red-500/50 text-sm font-bold hover:bg-red-500/40" onclick="filterPins('Combat')">COMBAT</button>
                <button class="px-4 py-1 rounded-full bg-blue-500/20 text-blue-300 border border-blue-500/50 text-sm font-bold hover:bg-blue-500/40" onclick="filterPins('Levitation')">LEVITATION</button>
            </div>

            <!-- Pin Grid -->
            <div id="pins-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                <!-- Populated by JS -->
            </div>
        </div>
    </section>

    <!-- View 5: Code Transcript -->
    <section id="view-code" class="hidden w-full max-w-5xl mx-auto space-y-8 animate-fade-in">
        <div class="bg-gray-900 rounded-xl border border-gray-700 p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl text-blue-300 psy-font">Application Source Code</h2>
                    <p class="text-gray-400 text-sm">Copy this code to save the application as a standalone .html file.</p>
                </div>
                <button onclick="copyFullCode()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <span class="material-symbols-outlined">content_copy</span> Copy Full File
                </button>
            </div>
            <div class="relative">
                <div class="absolute top-0 right-0 bg-gray-800 text-xs px-2 py-1 rounded-bl-lg text-gray-500">index.html</div>
                <div id="code-viewer" class="code-block h-[60vh] text-xs md:text-sm">
                    <!-- Code will be injected here on view -->
                    Loading source...
                </div>
            </div>
        </div>
    </section>

</main>

<!-- Detail Modal -->
<div id="detail-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeModal()"></div>
    <div id="modal-content" class="bg-gray-900 w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl border-4 flex flex-col relative overflow-hidden transform transition-all duration-300 scale-95 opacity-0">
        <!-- Header -->
        <div class="relative h-40 md:h-56 w-full flex-shrink-0 overflow-hidden" id="modal-header-bg">
            <img id="modal-img" src="" class="w-full h-full object-cover opacity-60">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent"></div>
            
            <button class="absolute top-4 right-4 bg-black/50 hover:bg-white/20 rounded-full p-2 text-white transition z-20" onclick="closeModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
            
            <div class="absolute bottom-4 left-6 z-10 w-full pr-12 flex justify-between items-end">
                <div>
                    <h2 class="text-4xl md:text-5xl text-white drop-shadow-lg psy-font tracking-wide" id="modal-title">Level Name</h2>
                    <div class="flex items-center gap-3 mt-1">
                        <p id="modal-subtitle" class="font-bold text-lg uppercase tracking-widest">Type</p>
                        <span id="modal-percent" class="px-2 py-0.5 bg-black/50 rounded text-sm font-bold">0%</span>
                    </div>
                </div>
                <!-- Complete Button -->
                 <button onclick="maxOutLevel()" class="mr-6 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg border border-green-400 transition-all active:scale-95 flex items-center gap-1">
                    <span class="material-symbols-outlined text-lg">done_all</span>
                    COMPLETE
                </button>
            </div>
        </div>
        <!-- Body -->
        <div id="modal-body" class="flex-grow overflow-y-auto p-6 custom-scrollbar bg-gray-900">
            <!-- Injected -->
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

    // --- Data ---
    const mentalWorlds = [
        { id: 'loboto', name: "Loboto's Labyrinth", color: "pink", image: "Images/Loboto's_Labyrinth.png", max: { figments: 80, baggage: 5, nuggets: 2, vaults: 2, hams: 0 } },
        { id: 'classroom', name: "Hollis' Classroom", color: "green", image: "Images/Holli's_Classroom.png", max: { figments: 42, baggage: 2, nuggets: 3, vaults: 1, hams: 2 } },
        { id: 'hotstreak', name: "Hollis' Hot Streak", color: "yellow", image: "Images/Holli's_Hot_Streak.png", max: { figments: 106, baggage: 3, nuggets: 4, vaults: 1, hams: 4 } },
        { id: 'compton', name: "Compton's Cookoff", color: "orange", image: "Images/Compton's_Cookoff.png", max: { figments: 51, baggage: 5, nuggets: 2, vaults: 2, hams: 2 } },
        { id: 'sensorium', name: "PSI King's Sensorium", color: "purple", image: "Images/Psi_King's_Sensorium.png", max: { figments: 263, baggage: 5, nuggets: 3, vaults: 2, hams: 4 } },
        { id: 'ford', name: "Ford's Follicles", color: "gray", image: "Images/Ford's_Follicles.png", max: { figments: 26, baggage: 1, nuggets: 1, vaults: 0, hams: 1 } },
        { id: 'strike', name: "Strike City", color: "blue", image: "Images/Strike_City.png", max: { figments: 52, baggage: 2, nuggets: 1, vaults: 1, hams: 1 } },
        { id: 'cruller', name: "Cruller's Correspondence", color: "teal", image: "Images/Cruller's_Correspondence.png", max: { figments: 14, baggage: 1, nuggets: 1, vaults: 1, hams: 0 } },
        { id: 'shark', name: "Tomb of the Sharkophagus", color: "teal", image: "Images/Tomb_Of_Sharkophagus.png", max: { figments: 16, baggage: 0, nuggets: 1, vaults: 1, hams: 1 } },
        { id: 'bob', name: "Bob's Bottles", color: "cyan", image: "Images/Bob's_Bottles.png", max: { figments: 165, baggage: 5, nuggets: 2, vaults: 2, hams: 2 } },
        { id: 'cassie', name: "Cassie's Collection", color: "yellow", image: "Images/Cassie's_Collection.png", max: { figments: 200, baggage: 5, nuggets: 2, vaults: 2, hams: 2 } },
        { id: 'lucrecia', name: "Lucrecia's Lament", color: "indigo", image: "Images/Lucrecia's_Lament.png", max: { figments: 30, baggage: 5, nuggets: 1, vaults: 1, hams: 0 } },
        { id: 'fatherland', name: "Fatherland Follies", color: "red", image: "Images/Fatherland_Follies.png", max: { figments: 90, baggage: 5, nuggets: 2, vaults: 2, hams: 0 } }
    ];

    const hubWorlds = [
        { id: 'motherlobe', name: "The Motherlobe", color: "yellow", image: "Images/The_Motherlobe.png", max: { psiCards: 27, supplyChests: 6, markers: 8 } },
        { id: 'quarry', name: "The Quarry", color: "blue", image: "Images/The_Quarry.png", max: { psiCards: 18, supplyChests: 4, markers: 5 } },
        { id: 'qa', name: "Questionable Area", color: "green", image: "Images/Questionable_Area.png", max: { psiCards: 27, supplyChests: 4, markers: 6 } },
        { id: 'gng', name: "Green Needle Gulch", color: "purple", image: "Images/Green_Needle_Gulch.png", max: { psiCards: 27, supplyChests: 2, markers: 4 } }
    ];

    const pinsData = [
        { name: "Sapphire Lev Ball", type: "Levitation", cost: 10, rank: 1, desc: "Soothing blue levitation ball." },
        { name: "Emerald Lev Ball", type: "Levitation", cost: 10, rank: 1, desc: "Natural green levitation ball." },
        { name: "Ruby Lev Ball", type: "Levitation", cost: 10, rank: 1, desc: "Rubious red levitation ball." },
        { name: "Cannonball", type: "Levitation", cost: 100, rank: 12, desc: "Smash lev ball to the ground." },
        { name: "Food For Thought", type: "Combat", cost: 200, rank: 18, desc: "Nodes restore mental energy." },
        { name: "Heavy Thoughts", type: "Combat", cost: 200, rank: 28, desc: "Anchor enemies in place." },
        { name: "Mental Tax", type: "Utility", cost: 200, rank: 40, desc: "Connections emit Psitantium." },
        { name: "Brain Drain", type: "Combat", cost: 400, rank: 56, desc: "Deplete enemy health via connection." },
        { name: "Fever Reducer", type: "Utility", cost: 200, rank: 14, desc: "Fire hurts less." },
        { name: "Goonade", type: "Combat", cost: 200, rank: 24, desc: "Doubts explode on death." },
        { name: "Beastmastery", type: "Utility", cost: 50, rank: 1, desc: "Pet animals with TK." },
        { name: "Plucky", type: "Combat", cost: 400, rank: 1, desc: "Pluck debris from ground." },
        { name: "Power Nap", type: "Combat", cost: 200, rank: 1, desc: "Longer stun duration." },
        { name: "Stun Gun", type: "Combat", cost: 100, rank: 1, desc: "PSI Blast stuns instead of damage." },
        { name: "Censory Overload", type: "Combat", cost: 500, rank: 32, desc: "More damage to Censors." },
        { name: "Chain Grain", type: "Combat", cost: 500, rank: 36, desc: "Extra blast chains." },
        { name: "Mental Block", type: "Utility", cost: 50, rank: 1, desc: "Longer Brain Block." },
        { name: "Speed Reader", type: "Utility", cost: 100, rank: 10, desc: "Faster Clairvoyance." },
        { name: "Time Warp", type: "Combat", cost: 400, rank: 36, desc: "Speeds up objects." },
        { name: "Bubble Wrap", type: "Combat", cost: 400, rank: 36, desc: "Bigger time bubble." },
        { name: "Bobby Pin", type: "Utility", cost: 50, rank: 1, desc: "Dance when idle." },
        { name: "Mental Magnet", type: "Utility", cost: 200, rank: 8, desc: "Increased pickup range." },
        { name: "Goo Proof", type: "Utility", cost: 200, rank: 22, desc: "No slow from goo." },
        { name: "Glass Cannon", type: "Combat", cost: 200, rank: 24, desc: "Deal more, take more dmg." },
        { name: "VIP Discount", type: "Utility", cost: 750, rank: 50, desc: "Store items cost less." },
        { name: "Psimultanium", type: "Utility", cost: 750, rank: 52, desc: "Double Psitanium drops." },
        { name: "Gag Order", type: "Utility", cost: 400, rank: 30, desc: "Muffles your Archetype." },
        { name: "Pixel Pal", type: "Utility", cost: 400, rank: 32, desc: "Retro Archetype look." },
        { name: "PSI Clone", type: "Utility", cost: 400, rank: 40, desc: "Archetype moves fast." },
        { name: "Wastepaper", type: "Combat", cost: 500, rank: 48, desc: "Archetype explodes on death." },
        { name: "Rainblows", type: "Combat", cost: 300, rank: 12, desc: "Rainbow punch effects." },
        { name: "Strike-onaut", type: "Combat", cost: 600, rank: 48, desc: "Stronger punches." },
        { name: "Mental Check", type: "Utility", cost: 50, rank: 5, desc: "Basic health check." } 
    ];

    const scavengerHuntItems = [
        "Day Old Sushi (Motherlobe)", "Deck of Cards (Motherlobe)", "Enemy Surveillance Device (Motherlobe)", 
        "Psychonauts Name Plaque (Motherlobe)", "Astronaut Ice Cream (Motherlobe)", 
        "Psitanium Knife (Quarry)", "Agent Orientation Laserdisc (Quarry)", "Unexploded Bomb (Quarry)",
        "Novelty Mug (Questionable Area)", "Human Skull (Questionable Area)", "Switchblade Hatchet (Questionable Area)", "Can of Corn (Questionable Area)",
        "Beehive Shaped Like My Phone (GNG)", "Mini Murder Bug Bot (GNG)", "Viking Helmet (GNG)", "Signed Copy of Mindswarm (GNG)"
    ];

    const sideQuests = [
        { id: 'queepie', name: "Dance, Baby, Dance", desc: "Find Queepie in 6 locations (Questionable Area).", max: 6 },
        { id: 'gisu', name: "Good Vibes Only", desc: "Find & repair 3 Psychoseismometers (Quarry, QA x2).", max: 3 },
        { id: 'fungus', name: "A Fungus Among Us", desc: "Find the fungus for Lili (Questionable Area behind waterfall).", max: 1 },
        { id: 'dion', name: "Family is in Tents", desc: "Help Dion set up the Aquatodome (Questionable Area).", max: 1 },
        { id: 'norma', name: "Keep Your Shirt On", desc: "Return all 16 Scavenger Hunt items to Norma.", max: 1 }
    ];

    const miscTasks = [
        { id: 'punch', name: "I LOVE PUNCHING!", desc: "Beat the punching mini-game in Basic Braining (Section 1)." },
        { id: 'rank102', name: "Unlimited Power!", desc: "Reach Rank 102 (Requires all collectibles)." },
        { id: 'gramophone', name: "Make It Stop!", desc: "Break 3 Gramophones in Fatherland Follies." }
    ];

    // --- State Management ---
    let userState = {
        mental: {},
        hubs: {},
        scavenger: [],
        quests: {},
        pins: [],
        misc: []
    };

    function getDefaults() {
        const def = { mental: {}, hubs: {}, scavenger: [], quests: {}, pins: [], misc: [] };
        mentalWorlds.forEach(l => { def.mental[l.id] = { figments: 0, baggage: 0, nuggets: 0, vaults: 0, hams: 0 }; });
        hubWorlds.forEach(h => { def.hubs[h.id] = { psiCards: 0, supplyChests: 0, markers: 0 }; });
        sideQuests.forEach(q => { def.quests[q.id] = 0; });
        return def;
    }

    const firebaseConfig = {
        apiKey: "AIzaSyCX2K1qLYZFkS-KamEOl3XRWPsjUCPTQOk",
        authDomain: "razz-1a47b.firebaseapp.com",
        projectId: "razz-1a47b",
        storageBucket: "razz-1a47b.firebasestorage.app",
        messagingSenderId: "770722102468",
        appId: "1:770722102468:web:0bec79747368441c20dd91",
        measurementId: "G-Z3K4G4QP98"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'razz-1a47b';
    const UNIVERSAL_SAVE_ID = 'universal_shared_save_file';
    
    let currentUser = null;
    let saveTimeout = null;

    async function initAuth() {
        document.getElementById('auth-status').innerText = "Connecting to Universal Mind...";
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    function saveData() {
        if (!currentUser) return;
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', UNIVERSAL_SAVE_ID, 'user_progress', 'progress');
                await setDoc(docRef, userState, { merge: true });
            } catch (e) {
                console.error("Save failed", e);
            }
        }, 1000); 
    }

    async function init() {
        userState = getDefaults();
        renderMentalGrid();
        renderHubGrid();
        renderMissions();
        renderPins();
        
        try {
            await initAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-status').innerText = "Syncing Universal Mind...";
                    const docRef = doc(db, 'artifacts', appId, 'users', UNIVERSAL_SAVE_ID, 'user_progress', 'progress');
                    onSnapshot(docRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const cloudData = snapshot.data();
                            userState.scavenger = cloudData.scavenger || [];
                            userState.pins = cloudData.pins || [];
                            userState.misc = cloudData.misc || [];
                            if(cloudData.mental) {
                                Object.keys(userState.mental).forEach(k => {
                                    if(cloudData.mental[k]) userState.mental[k] = cloudData.mental[k];
                                });
                            }
                            if(cloudData.hubs) {
                                Object.keys(userState.hubs).forEach(k => {
                                    if(cloudData.hubs[k]) userState.hubs[k] = cloudData.hubs[k];
                                });
                            }
                            if(cloudData.quests) {
                                Object.keys(userState.quests).forEach(k => {
                                    if(typeof cloudData.quests[k] !== 'undefined') userState.quests[k] = cloudData.quests[k];
                                });
                            }
                        } 
                        renderMentalGrid();
                        renderHubGrid();
                        renderMissions();
                        renderPins();
                        updateGlobalStats();
                        if (currentModalData) renderModalBody(); 
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                    });
                }
            });
        } catch (e) {
            document.getElementById('auth-status').innerText = "Offline Mode";
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
        }
        switchTab('menu');
    }

    function updateGlobalStats() {
        let rankPoints = 0;
        let totalCompletionVal = 0;
        let totalMaxVal = 0;
        mentalWorlds.forEach(l => {
            const s = userState.mental[l.id];
            const m = l.max;
            rankPoints += (s.figments / 100) + (s.nuggets) + (s.vaults) + (s.baggage * 0.2); 
            totalCompletionVal += s.figments + (s.baggage * 5) + (s.nuggets * 10) + (s.vaults * 10) + (s.hams * 5);
            totalMaxVal += m.figments + (m.baggage * 5) + (m.nuggets * 10) + (m.vaults * 10) + (m.hams * 5);
        });
        let totalCards = 0;
        hubWorlds.forEach(h => {
            const s = userState.hubs[h.id];
            const m = h.max;
            totalCards += s.psiCards;
            rankPoints += s.markers;
            totalCompletionVal += s.psiCards + (s.supplyChests * 5) + (s.markers * 10);
            totalMaxVal += m.psiCards + (m.supplyChests * 5) + (m.markers * 10);
        });
        rankPoints += Math.floor(totalCards / 9);
        rankPoints += (userState.scavenger.length / 2);
        totalCompletionVal += userState.scavenger.length * 5;
        totalMaxVal += scavengerHuntItems.length * 5;
        sideQuests.forEach(q => {
            rankPoints += userState.quests[q.id];
            totalCompletionVal += userState.quests[q.id] * 10;
            totalMaxVal += q.max * 10;
        });
        totalCompletionVal += userState.pins.length * 5;
        totalMaxVal += pinsData.length * 5;
        totalCompletionVal += userState.misc.length * 10;
        totalMaxVal += miscTasks.length * 10;
        const finalRank = Math.floor(rankPoints) + 1;
        const percent = totalMaxVal > 0 ? Math.floor((totalCompletionVal / totalMaxVal) * 100) : 0;
        document.getElementById('current-rank').innerText = Math.min(finalRank, 102);
        document.getElementById('global-percent').innerText = `${Math.min(percent, 100)}%`;
        const titles = ["Intern", "Junior", "Agent", "Senior", "Special", "Head"];
        const tIdx = Math.min(Math.floor(finalRank / 20), titles.length - 1);
        document.getElementById('rank-title').innerText = titles[tIdx];
    }

    function renderMentalGrid() {
        const grid = document.getElementById('mental-grid');
        grid.innerHTML = mentalWorlds.map(l => createCard(l, 'mental')).join('');
    }
    function renderHubGrid() {
        const grid = document.getElementById('hubs-grid');
        grid.innerHTML = hubWorlds.map(l => createCard(l, 'hub')).join('');
    }
    function createCard(data, type) {
        const s = type === 'mental' ? userState.mental[data.id] : userState.hubs[data.id];
        const m = data.max;
        let maxP = 0, currP = 0;
        if (type === 'mental') {
            maxP = m.figments + m.baggage + m.nuggets + m.vaults + m.hams;
            currP = s.figments + s.baggage + s.nuggets + s.vaults + s.hams;
        } else {
            maxP = m.psiCards + m.supplyChests + m.markers;
            currP = s.psiCards + s.supplyChests + s.markers;
        }
        const pct = maxP === 0 ? 100 : Math.floor((currP / maxP) * 100);
        const isDone = pct >= 100;
        return `
            <div onclick="openModal('${data.id}', '${type}')" class="skew-card relative h-64 rounded-2xl overflow-hidden cursor-pointer shadow-xl group bg-gray-800 border-2 ${isDone ? 'border-green-500' : 'border-gray-700'} hover:border-${data.color}-400 transition-all duration-300">
                <div class="absolute inset-0">
                    <img src="${data.image}" class="w-full h-full object-cover group-hover:scale-110 transition-all duration-700" alt="${data.name}">
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
                </div>
                <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/90 to-transparent">
                    <div class="flex justify-between items-end">
                        <div>
                            <h3 class="text-xl md:text-2xl text-white psy-font leading-none mb-1 group-hover:text-${data.color}-400 transition-colors">${data.name}</h3>
                            <p class="text-xs font-bold uppercase text-gray-400 tracking-widest">${type === 'mental' ? 'Brain' : 'Location'}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold ${isDone ? 'text-green-400' : 'text-white'} psy-font">${pct}%</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 h-1.5 rounded-full mt-2 overflow-hidden">
                        <div class="h-full bg-${data.color}-500" style="width: ${pct}%"></div>
                    </div>
                </div>
                ${isDone ? '<div class="absolute top-3 right-3 bg-green-500 text-black text-xs font-bold px-2 py-1 rounded transform rotate-3 shadow-lg">COMPLETE</div>' : ''}
            </div>
        `;
    }

    function renderMissions() {
        const scavList = document.getElementById('scavenger-list');
        scavList.innerHTML = scavengerHuntItems.map((item, idx) => {
            const checked = userState.scavenger.includes(idx);
            return `
                <label class="flex items-center p-3 bg-gray-900/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition border border-gray-700 border-l-4 border-l-yellow-500">
                    <input type="checkbox" class="mission-checkbox w-5 h-5 rounded border-gray-600 text-yellow-500 focus:ring-yellow-500 bg-gray-800" 
                        ${checked ? 'checked' : ''} onchange="toggleScavenger(${idx})">
                    <div class="ml-3 text-sm text-gray-200 font-medium select-none transition-colors">${item}</div>
                    <span class="hidden ml-auto text-green-400 material-symbols-outlined text-lg">check_circle</span>
                </label>
            `;
        }).join('');
        document.getElementById('scavenger-progress').innerText = `${userState.scavenger.length}/${scavengerHuntItems.length}`;
        const questList = document.getElementById('side-quests-list');
        questList.innerHTML = sideQuests.map(q => {
            const current = userState.quests[q.id];
            const isDone = current === q.max;
            let steps = '';
            for(let i=0; i<q.max; i++) {
                steps += `<div class="w-6 h-6 rounded-full border-2 ${i < current ? 'bg-purple-500 border-purple-500' : 'bg-transparent border-gray-600'} flex items-center justify-center transition-all cursor-pointer hover:border-white" onclick="setQuest('${q.id}', ${i+1})">
                    ${i < current ? '<span class="material-symbols-outlined text-xs text-white">check</span>' : ''}
                </div>`;
            }
            return `
                <div class="flex flex-col md:flex-row md:items-center justify-between bg-gray-900/50 p-4 rounded-xl border border-gray-700 gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-white ${isDone ? 'text-green-400 line-through' : ''}">${q.name}</h3>
                        <p class="text-sm text-gray-400">${q.desc}</p>
                    </div>
                    <div class="flex gap-2">
                        ${steps}
                        <button class="ml-2 text-xs text-red-400 hover:text-red-300 underline" onclick="setQuest('${q.id}', 0)">Reset</button>
                    </div>
                </div>
            `;
        }).join('');
        document.getElementById('misc-tasks-list').innerHTML = miscTasks.map(t => `
            <label class="flex items-center p-3 bg-gray-900/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition border border-gray-700 border-l-4 border-l-blue-500">
                <input type="checkbox" class="mission-checkbox w-5 h-5 rounded border-gray-600 text-blue-500 focus:ring-blue-500 bg-gray-800" 
                    ${userState.misc.includes(t.id) ? 'checked' : ''} onchange="toggleMisc('${t.id}')">
                <div class="ml-3 text-sm text-gray-200 font-medium select-none">
                    <div class="font-bold">${t.name}</div>
                    <div class="text-xs text-gray-400">${t.desc}</div>
                </div>
            </label>
        `).join('');
    }

    function renderPins() {
        const grid = document.getElementById('pins-grid');
        grid.innerHTML = pinsData.map((pin, idx) => {
            const owned = userState.pins.includes(idx);
            return `
                <div class="pin-card ${owned ? 'owned' : ''} bg-gray-800 rounded-xl border-2 border-gray-700 p-3 flex flex-col items-center text-center cursor-pointer h-full" onclick="togglePin(${idx})">
                    <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-gray-900 mb-2 flex items-center justify-center overflow-hidden border border-gray-600 relative">
                        <div class="absolute inset-0 bg-${getPinColor(pin.type)}-500/20"></div>
                        <span class="material-symbols-outlined text-2xl md:text-3xl text-${getPinColor(pin.type)}-400">${getPinIcon(pin.type)}</span>
                    </div>
                    <h4 class="text-xs md:text-sm font-bold text-white leading-tight mb-1">${pin.name}</h4>
                    <p class="text-[10px] text-gray-400 mb-2">${pin.type}</p>
                    ${owned ? 
                        '<span class="mt-auto text-green-400 text-xs font-bold">OWNED</span>' : 
                        `<div class="mt-auto text-[10px] text-yellow-500 bg-black/40 px-2 py-1 rounded border border-yellow-500/30">
                            ${pin.cost} <span class="text-[8px]">PSI</span> | R${pin.rank}
                         </div>`
                    }
                </div>
            `;
        }).join('');
        document.getElementById('pins-collected-count').innerText = `${userState.pins.length}/${pinsData.length}`;
    }

    function getPinColor(type) {
        if(type === 'Combat') return 'red';
        if(type === 'Levitation') return 'blue';
        return 'purple';
    }
    function getPinIcon(type) {
        if(type === 'Combat') return 'swords';
        if(type === 'Levitation') return 'flight';
        return 'psychology';
    }

    window.filterPins = (type) => {
        const cards = document.getElementById('pins-grid').children;
        pinsData.forEach((pin, idx) => {
            if (type === 'all' || pin.type === type) {
                cards[idx].style.display = 'flex';
            } else {
                cards[idx].style.display = 'none';
            }
        });
    };
    window.togglePin = (idx) => {
        if(userState.pins.includes(idx)) userState.pins = userState.pins.filter(i => i !== idx);
        else userState.pins.push(idx);
        renderPins(); updateGlobalStats(); saveData();
    };
    window.toggleScavenger = (idx) => {
        if(userState.scavenger.includes(idx)) userState.scavenger = userState.scavenger.filter(i => i !== idx);
        else userState.scavenger.push(idx);
        renderMissions(); updateGlobalStats(); saveData();
    };
    window.toggleMisc = (id) => {
        if(userState.misc.includes(id)) userState.misc = userState.misc.filter(i => i !== id);
        else userState.misc.push(id);
        renderMissions(); updateGlobalStats(); saveData();
    };
    window.setQuest = (id, val) => {
        const cur = userState.quests[id];
        if (val === cur) userState.quests[id] = val - 1; 
        else userState.quests[id] = val;
        renderMissions(); updateGlobalStats(); saveData();
    };

    let currentModalData = null;
    let currentModalType = null;

    window.openModal = (id, type) => {
        currentModalType = type;
        const data = type === 'mental' ? mentalWorlds.find(x => x.id === id) : hubWorlds.find(x => x.id === id);
        currentModalData = data;
        
        const modal = document.getElementById('detail-modal');
        const content = document.getElementById('modal-content');
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('opacity-0', 'scale-95');
            content.classList.add('opacity-100', 'scale-100');
        }, 10);
        
        document.getElementById('modal-title').innerText = data.name;
        document.getElementById('modal-subtitle').innerText = type === 'mental' ? 'Mental World' : 'Hub Location';
        document.getElementById('modal-img').src = data.image;
        content.style.borderColor = `var(--psy-${data.color})`;

        renderModalBody();
    };

    function updateModalPercent() {
        if (!currentModalData) return;
        const id = currentModalData.id;
        const m = currentModalData.max;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        let maxP = 0, currP = 0;
        if (currentModalType === 'mental') {
            maxP = m.figments + m.baggage + m.nuggets + m.vaults + m.hams;
            currP = s.figments + s.baggage + s.nuggets + s.vaults + s.hams;
        } else {
            maxP = m.psiCards + m.supplyChests + m.markers;
            currP = s.psiCards + s.supplyChests + s.markers;
        }
        const pct = maxP === 0 ? 100 : Math.floor((currP / maxP) * 100);
        document.getElementById('modal-percent').innerText = `${pct}%`;
    }

    function renderModalBody() {
        const id = currentModalData.id;
        const m = currentModalData.max;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        const container = document.getElementById('modal-body');
        let contentHtml = '';
        if (currentModalType === 'mental') {
            contentHtml += createTrackerRow('Figments', 'gesture', 'pink', s.figments, m.figments, 'figments', true);
            contentHtml += createTrackerRow('Emotional Baggage', 'shopping_bag', 'blue', s.baggage, m.baggage, 'baggage');
            contentHtml += createTrackerRow('Nuggets of Wisdom', 'hotel_class', 'yellow', s.nuggets, m.nuggets, 'nuggets');
            contentHtml += createTrackerRow('Memory Vaults', 'lock_open', 'green', s.vaults, m.vaults, 'vaults');
            contentHtml += createTrackerRow('Half-A-Minds', 'psychology_alt', 'purple', s.hams, m.hams, 'hams');
        } else {
            contentHtml += createTrackerRow('PSI Cards', 'style', 'cyan', s.psiCards, m.psiCards, 'psiCards', true); 
            contentHtml += createTrackerRow('Supply Chests', 'inventory_2', 'orange', s.supplyChests, m.supplyChests, 'supplyChests');
            contentHtml += createTrackerRow('PSI Challenge Markers', 'share_location', 'red', s.markers, m.markers, 'markers');
        }
        container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${contentHtml}</div>`;
        updateModalPercent();
    }

    function createTrackerRow(title, icon, color, current, max, key, isSlider = false) {
        if (max === 0) return ''; 
        let controls = '';
        if (isSlider) {
            // Custom styled slider that mimics the original bar look
            controls = `
                <div class="flex items-center gap-3 bg-gray-800 rounded-lg p-2 mt-2">
                    <button onclick="updateVal('${key}', -1)" class="w-8 h-8 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold shadow">-</button>
                    <div class="flex-grow relative h-5">
                        <input type="range" min="0" max="${max}" value="${current}" 
                               oninput="handleSliderInput('${key}', this.value, '${color}')"
                               class="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer">
                        <div class="absolute inset-0 bg-gray-700 rounded-full overflow-hidden pointer-events-none">
                            <div id="bar-${key}" class="h-full bg-${color}-500 transition-all duration-75 ease-out" style="width: ${(current/max)*100}%"></div>
                        </div>
                    </div>
                    <button onclick="updateVal('${key}', 1)" class="w-8 h-8 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold shadow">+</button>
                </div>
            `;
        } else {
            let checks = '';
            for(let i=0; i<max; i++) {
                const isActive = i < current;
                checks += `<button onclick="setVal('${key}', ${isActive && i === current-1 ? i : i+1})" class="w-10 h-10 rounded-full border-2 ${isActive ? `bg-${color}-500 border-${color}-400 text-black` : 'bg-gray-800 border-gray-600 text-gray-600'} flex items-center justify-center transition-all hover:scale-110">
                    <span class="material-symbols-outlined text-lg">${icon}</span>
                </button>`;
            }
            controls = `<div class="flex flex-wrap gap-2 mt-2">${checks}</div>`;
        }

        return `
            <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4 hover:border-${color}-500 transition-colors">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2 text-${color}-400">
                        <span class="material-symbols-outlined text-xl">${icon}</span>
                        <span class="font-bold text-lg">${title}</span>
                    </div>
                    <div class="text-2xl psy-font text-white" id="tracker-num-${key}">${current}/${max}</div>
                </div>
                ${controls}
            </div>
        `;
    }

    window.handleSliderInput = (key, valStr, color) => {
        const val = parseInt(valStr);
        if (!currentModalData) return;
        const id = currentModalData.id;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        s[key] = val; 
        
        // Update DOM immediately for responsiveness
        const el = document.getElementById(`tracker-num-${key}`);
        if(el) el.innerText = `${val}/${currentModalData.max[key]}`;
        
        const bar = document.getElementById(`bar-${key}`);
        if(bar) bar.style.width = `${(val / currentModalData.max[key]) * 100}%`;
        
        updateModalPercent();
        updateGlobalStats();
        saveData();
    };

    window.maxOutLevel = () => {
        if (!currentModalData) return;
        const id = currentModalData.id;
        const m = currentModalData.max;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        Object.keys(m).forEach(key => s[key] = m[key]);
        renderModalBody();
        updateGlobalStats();
        saveData();
        if(currentModalType === 'mental') renderMentalGrid(); else renderHubGrid();
    };

    window.updateVal = (key, delta) => {
        const id = currentModalData.id;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        const max = currentModalData.max[key];
        let newVal = s[key] + delta;
        if (newVal < 0) newVal = 0;
        if (newVal > max) newVal = max;
        s[key] = newVal;
        renderModalBody(); 
        updateGlobalStats(); 
        saveData();
        if(currentModalType === 'mental') renderMentalGrid(); else renderHubGrid();
    };

    window.setVal = (key, val) => {
        const id = currentModalData.id;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        s[key] = val;
        renderModalBody();
        updateGlobalStats();
        saveData();
        if(currentModalType === 'mental') renderMentalGrid(); else renderHubGrid();
    };

    window.closeModal = () => {
        const content = document.getElementById('modal-content');
        content.classList.remove('opacity-100', 'scale-100');
        content.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            document.getElementById('detail-modal').classList.add('hidden');
            currentModalData = null;
        }, 300);
    };

    window.switchTab = (tab) => {
        ['mental', 'hubs', 'missions', 'ottomatic', 'code', 'menu'].forEach(t => {
            const el = document.getElementById(`view-${t}`);
            if (el) el.classList.add('hidden');
        });
        
        const activeView = document.getElementById(`view-${tab}`);
        if (activeView) activeView.classList.remove('hidden');

        const backBtn = document.getElementById('back-btn');
        if (tab === 'menu') {
            backBtn.classList.add('hidden');
        } else {
            backBtn.classList.remove('hidden');
        }

        if (tab === 'code') renderCode();
    };

    function renderCode() {
        const fullHTML = document.documentElement.outerHTML;
        document.getElementById('code-viewer').innerText = fullHTML;
    }

    window.copyFullCode = () => {
        const code = document.documentElement.outerHTML;
        navigator.clipboard.writeText(code).then(() => {
            alert('Full HTML code copied to clipboard!');
        });
    }

    init();

</script>
</body>
</html>
