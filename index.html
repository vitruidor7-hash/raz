<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raz's Field Journal - Universal Sync</title>
    <!-- Standard Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&amp;family=Fredoka:wght@400;600&amp;display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '375px',
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>

    <style id="app-styles">
        :root {
            --psy-purple: #2D1E2F;
            --psy-green: #A9D046;
            --psy-orange: #F58F29;
            --psy-blue: #48ACF0;
            --psy-pink: #E84855;
            --psy-yellow: #FFD700;
            --psy-teal: #2EC4B6;
        }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--psy-purple);
            background-image: radial-gradient(circle at 20% 20%, rgba(72, 172, 240, 0.15) 0%, transparent 20%),
                              radial-gradient(circle at 80% 80%, rgba(169, 208, 70, 0.15) 0%, transparent 20%);
            color: white;
            overflow-x: hidden;
            /* Prevent pull-to-refresh on mobile to feel more like an app */
            overscroll-behavior-y: none;
        }

        h1, h2, h3, .psy-font {
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1a111b; 
        }
        ::-webkit-scrollbar-thumb {
            background: var(--psy-green); 
            border-radius: 10px;
        }

        .skew-card {
            /* Reduced skew on mobile for better readability */
            transform: perspective(1000px) rotateY(0deg);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @media (min-width: 768px) {
            .skew-card {
                transform: perspective(1000px) rotateY(2deg) rotateZ(-1deg);
            }
            .skew-card:hover {
                transform: perspective(1000px) rotateY(0deg) rotateZ(0deg) scale(1.02);
                z-index: 10;
                box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            }
        }

        .rank-badge {
            background: conic-gradient(from 0deg, var(--psy-orange), var(--psy-yellow), var(--psy-green), var(--psy-blue), var(--psy-purple), var(--psy-orange));
            animation: spin 10s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .glass-panel {
            background: rgba(29, 22, 30, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pin-card {
            transition: all 0.2s ease;
            filter: grayscale(100%) opacity(0.6);
        }
        .pin-card.owned {
            filter: grayscale(0%) opacity(1);
            border-color: var(--psy-yellow);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .pin-card:active {
            transform: scale(0.95);
        }

        /* CRT Effect for Ottomatic - Adjusted for mobile */
        .ottomatic-screen {
            background: radial-gradient(circle, #2a2a2a 0%, #000 100%);
            position: relative;
            overflow: hidden;
        }
        @media (min-width: 768px) {
            .ottomatic-screen {
                border: 8px solid #444;
                box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            }
            .ottomatic-screen::before {
                content: " ";
                display: block;
                position: absolute;
                top: 0; left: 0; bottom: 0; right: 0;
                background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
                z-index: 2;
                background-size: 100% 2px, 3px 100%;
                pointer-events: none;
            }
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid #333;
            white-space: pre;
        }

        /* Menu Styles */
        .menu-btn {
            transition: all 0.2s ease;
        }
        .menu-btn:active {
            transform: scale(0.96);
        }
        @media (min-width: 768px) {
             .menu-btn:hover {
                transform: scale(1.05) rotate(-2deg);
                box-shadow: 0 0 20px var(--hover-color);
                border-color: white;
            }
        }

        .menu-bg-overlay {
            background: radial-gradient(circle at center, transparent 0%, #2D1E2F 90%);
        }

        /* Bottom Nav Active State */
        .nav-item.active {
            color: var(--psy-green);
        }
        .nav-item.active span {
            font-variation-settings: 'FILL' 1;
        }

        /* Bottom Sheet Animation */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-24 md:pb-0">

<!-- Loading Screen -->
<div id="loader" class="fixed inset-0 bg-[#2D1E2F] z-[100] flex flex-col items-center justify-center">
    <div class="relative w-24 h-24">
        <div class="absolute inset-0 rounded-full border-4 border-green-500 border-t-transparent animate-spin"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <span class="material-symbols-outlined text-4xl text-green-400 animate-pulse">psychology</span>
        </div>
    </div>
    <h2 class="mt-4 text-xl text-green-400 psy-font tracking-widest">Establishing Psychic Link...</h2>
    <p class="text-sm text-gray-500" id="auth-status">Accessing Universal Mind...</p>
</div>

<!-- Mobile Header -->
<header class="glass-panel sticky top-0 z-40 px-4 py-3 shadow-lg border-b border-white/10 md:border-b-4 md:border-green-500">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <!-- Left: Brand (Compact on mobile) -->
        <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('menu')">
            <div class="relative w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden border-2 border-white shadow-lg bg-green-500 flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl md:text-3xl text-white">psychology</span>
            </div>
            <div class="hidden xs:block">
                <h1 class="text-xl md:text-3xl text-white leading-none">Raz's Journal</h1>
                <p class="text-[10px] md:text-sm text-green-400 font-bold tracking-wider uppercase">Universal Sync</p>
            </div>
        </div>

        <!-- Right: Rank Stats (Condensed) -->
        <div class="flex items-center gap-3">
             <div class="flex flex-col items-end">
                <div class="flex items-center gap-2">
                    <span class="text-yellow-400 font-bold text-sm md:text-lg leading-none" id="rank-title">Intern</span>
                    <div class="bg-gray-800 rounded-full w-8 h-8 flex items-center justify-center border border-yellow-400 relative overflow-hidden">
                        <div class="absolute inset-0 rank-badge opacity-50"></div>
                        <span class="relative z-10 text-white text-xs font-bold" id="current-rank">1</span>
                    </div>
                </div>
                <span class="text-xs text-green-400 font-bold" id="global-percent">0%</span>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full relative">

    <!-- MAIN MENU (Desktop: Grid, Mobile: Hidden/Simplified) -->
    <section id="view-menu" class="absolute inset-0 z-30 flex items-center justify-center p-4">
        <!-- Background Image Layer -->
        <div class="absolute inset-0 z-0 overflow-hidden">
            <img src="Images/Menu_Background.png" onerror="this.style.display='none'" class="w-full h-full object-cover opacity-40 animate-pulse-slow">
            <div class="absolute inset-0 bg-gradient-to-br from-purple-900 via-gray-900 to-black -z-10"></div>
            <div class="absolute inset-0 menu-bg-overlay"></div>
        </div>

        <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 max-w-4xl w-full pb-20 md:pb-0">
            <!-- Mobile Only Intro Text -->
            <div class="md:hidden text-center mb-4">
                <h2 class="text-3xl text-white psy-font">Welcome Agent</h2>
                <p class="text-gray-300 text-sm">Select a category below to begin tracking.</p>
            </div>

            <!-- Mental Worlds -->
            <button onclick="switchTab('mental')" class="menu-btn group relative h-32 md:h-56 rounded-3xl bg-gray-800/80 border-l-4 border-pink-500 md:border-4 hover:bg-pink-900/80 flex flex-row md:flex-col items-center md:justify-center overflow-hidden p-4 gap-4" style="--hover-color: rgba(232, 85, 85, 0.5)">
                <span class="material-symbols-outlined text-4xl md:text-6xl text-pink-400 md:mb-2 bg-pink-900/50 p-3 rounded-full md:bg-transparent md:p-0">psychology_alt</span>
                <div class="text-left md:text-center">
                    <h2 class="text-2xl md:text-4xl text-white psy-font tracking-wider">Mental Worlds</h2>
                    <p class="text-pink-300 font-bold uppercase text-xs md:tracking-widest md:text-sm">Explore The Mind</p>
                </div>
            </button>

            <!-- Hub Worlds -->
            <button onclick="switchTab('hubs')" class="menu-btn group relative h-32 md:h-56 rounded-3xl bg-gray-800/80 border-l-4 border-green-500 md:border-4 hover:bg-green-900/80 flex flex-row md:flex-col items-center md:justify-center overflow-hidden p-4 gap-4" style="--hover-color: rgba(169, 208, 70, 0.5)">
                <span class="material-symbols-outlined text-4xl md:text-6xl text-green-400 md:mb-2 bg-green-900/50 p-3 rounded-full md:bg-transparent md:p-0">public</span>
                <div class="text-left md:text-center">
                    <h2 class="text-2xl md:text-4xl text-white psy-font tracking-wider">Real World</h2>
                    <p class="text-green-300 font-bold uppercase text-xs md:tracking-widest md:text-sm">Explore The Camp</p>
                </div>
            </button>

            <!-- Missions -->
            <button onclick="switchTab('missions')" class="menu-btn group relative h-32 md:h-56 rounded-3xl bg-gray-800/80 border-l-4 border-blue-500 md:border-4 hover:bg-blue-900/80 flex flex-row md:flex-col items-center md:justify-center overflow-hidden p-4 gap-4" style="--hover-color: rgba(72, 172, 240, 0.5)">
                <span class="material-symbols-outlined text-4xl md:text-6xl text-blue-400 md:mb-2 bg-blue-900/50 p-3 rounded-full md:bg-transparent md:p-0">assignment_late</span>
                <div class="text-left md:text-center">
                    <h2 class="text-2xl md:text-4xl text-white psy-font tracking-wider">Mission Log</h2>
                    <p class="text-blue-300 font-bold uppercase text-xs md:tracking-widest md:text-sm">Scavenger Hunt</p>
                </div>
            </button>

            <!-- Ottomatic -->
            <button onclick="switchTab('ottomatic')" class="menu-btn group relative h-32 md:h-56 rounded-3xl bg-gray-800/80 border-l-4 border-yellow-500 md:border-4 hover:bg-yellow-900/80 flex flex-row md:flex-col items-center md:justify-center overflow-hidden p-4 gap-4" style="--hover-color: rgba(255, 215, 0, 0.5)">
                <span class="material-symbols-outlined text-4xl md:text-6xl text-yellow-400 md:mb-2 bg-yellow-900/50 p-3 rounded-full md:bg-transparent md:p-0">shopping_cart</span>
                <div class="text-left md:text-center">
                    <h2 class="text-2xl md:text-4xl text-white psy-font tracking-wider">The Store</h2>
                    <p class="text-yellow-300 font-bold uppercase text-xs md:tracking-widest md:text-sm">Buy Pins & Items</p>
                </div>
            </button>
            
             <!-- Code Button -->
            <button onclick="switchTab('code')" class="md:col-span-2 menu-btn group h-16 rounded-2xl bg-gray-900/50 border border-gray-600 flex items-center justify-center gap-2 text-gray-400 hover:text-white text-sm">
                <span class="material-symbols-outlined text-lg">code</span>
                <span>Source Code</span>
            </button>
        </div>
    </section>

    <!-- View 1: Mental Worlds -->
    <section id="view-mental" class="space-y-6 hidden animate-fade-in pb-12">
         <h2 class="md:hidden text-2xl text-pink-300 psy-font pl-1">Mental Worlds</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6" id="mental-grid">
            <!-- Populated by JS -->
        </div>
    </section>

    <!-- View 2: Hub Worlds -->
    <section id="view-hubs" class="hidden space-y-4 md:space-y-6 animate-fade-in pb-12">
        <div class="bg-blue-900/30 border border-blue-500/30 rounded-2xl p-4 md:p-6 text-center">
            <h2 class="text-xl md:text-2xl text-blue-300 mb-1">Real World Exploration</h2>
            <p class="text-sm md:text-base text-gray-400 max-w-2xl mx-auto">Collect PSI Cards, Supply Chests, and Markers.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8" id="hubs-grid">
             <!-- Populated by JS -->
        </div>
    </section>

    <!-- View 3: Mission Log -->
    <section id="view-missions" class="hidden max-w-5xl mx-auto grid md:grid-cols-2 gap-6 md:gap-8 animate-fade-in pb-12">
        <!-- Scavenger Hunt -->
        <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700 md:col-span-2 lg:col-span-1">
            <div class="relative h-32 md:h-48 bg-yellow-900/20 overflow-hidden">
                <div class="w-full h-full bg-gradient-to-br from-yellow-900 to-yellow-700 flex items-center justify-center opacity-50">
                    <span class="material-symbols-outlined text-8xl md:text-9xl text-white/10 transform rotate-12">checklist</span>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-gray-800 to-transparent"></div>
                <div class="absolute bottom-3 left-4 md:bottom-4 md:left-6">
                    <h2 class="text-2xl md:text-3xl text-yellow-400 psy-font drop-shadow-md">Scavenger Hunt</h2>
                    <p class="text-gray-300 text-xs md:text-sm font-bold uppercase">Mission Critical</p>
                </div>
                <div class="absolute top-3 right-3 md:top-4 md:right-4 bg-black/50 px-3 py-1 rounded-full text-yellow-400 font-bold text-sm" id="scavenger-progress">0/16</div>
            </div>
            <!-- Removed max-height on mobile for better scrolling -->
            <div id="scavenger-list" class="p-4 grid grid-cols-1 gap-3 max-h-none md:max-h-[600px] md:overflow-y-auto custom-scrollbar">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Side Quests List -->
        <div class="md:col-span-2 lg:col-span-1 space-y-6 md:space-y-8">
            <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700">
                <div class="p-4 md:p-6 border-b border-gray-700 bg-purple-900/20">
                    <h2 class="text-xl md:text-2xl text-purple-400 psy-font">Side Assignments</h2>
                </div>
                <div id="side-quests-list" class="p-4 md:p-6 space-y-4 md:space-y-6">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Misc Tasks -->
            <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700">
                <div class="p-4 md:p-6 border-b border-gray-700 bg-blue-900/20">
                    <h2 class="text-xl md:text-2xl text-blue-400 psy-font">Field Tasks</h2>
                </div>
                <div id="misc-tasks-list" class="p-4 md:p-6 space-y-3 md:space-y-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </section>

    <!-- View 4: The Ottomatic -->
    <section id="view-ottomatic" class="hidden w-full max-w-6xl mx-auto animate-fade-in pb-12">
        <!-- Removed fixed height on mobile -->
        <div class="ottomatic-screen rounded-none md:rounded-3xl p-4 md:p-10 min-h-screen md:min-h-[80vh] -mx-4 md:mx-0">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b-2 border-white/10 pb-4 gap-4">
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="w-12 h-12 md:w-16 md:h-16 rounded-full border-2 border-yellow-400 bg-gray-800 flex items-center justify-center overflow-hidden shrink-0">
                         <span class="material-symbols-outlined text-3xl md:text-4xl text-yellow-400">smart_toy</span>
                    </div>
                    <div>
                        <h2 class="text-3xl md:text-4xl text-yellow-400 psy-font tracking-widest">OTTO-MATIC</h2>
                        <p class="text-green-400 font-mono text-xs md:text-sm"> &gt; WELCOME AGENT.</p>
                    </div>
                </div>
                <div class="bg-black/50 px-4 py-2 md:px-6 md:py-3 rounded-lg border border-green-500/30 w-full md:w-auto text-center md:text-right">
                    <div class="text-[10px] md:text-xs text-gray-400 font-mono uppercase">Pins Collected</div>
                    <div class="text-2xl md:text-3xl text-white font-mono" id="pins-collected-count">0/33</div>
                </div>
            </div>
            
            <!-- Filter Buttons (Scrollable on mobile) -->
            <div class="flex overflow-x-auto pb-2 mb-4 gap-2 md:flex-wrap no-scrollbar">
                <button class="flex-shrink-0 px-4 py-2 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/50 text-xs md:text-sm font-bold whitespace-nowrap active:bg-yellow-500/40" onclick="filterPins('all')">ALL</button>
                <button class="flex-shrink-0 px-4 py-2 rounded-full bg-purple-500/20 text-purple-300 border border-purple-500/50 text-xs md:text-sm font-bold whitespace-nowrap active:bg-purple-500/40" onclick="filterPins('Utility')">UTILITY</button>
                <button class="flex-shrink-0 px-4 py-2 rounded-full bg-red-500/20 text-red-300 border border-red-500/50 text-xs md:text-sm font-bold whitespace-nowrap active:bg-red-500/40" onclick="filterPins('Combat')">COMBAT</button>
                <button class="flex-shrink-0 px-4 py-2 rounded-full bg-blue-500/20 text-blue-300 border border-blue-500/50 text-xs md:text-sm font-bold whitespace-nowrap active:bg-blue-500/40" onclick="filterPins('Levitation')">LEVITATION</button>
            </div>

            <!-- Pin Grid (Natural scroll on mobile) -->
            <div id="pins-grid" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4 h-auto md:h-[60vh] md:overflow-y-auto custom-scrollbar pr-1 pb-24 md:pb-0">
                <!-- Populated by JS -->
            </div>
        </div>
    </section>

    <!-- View 5: Code Transcript -->
    <section id="view-code" class="hidden w-full max-w-5xl mx-auto space-y-8 animate-fade-in pb-20">
        <div class="bg-gray-900 rounded-xl border border-gray-700 p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl md:text-2xl text-blue-300 psy-font">Source Code</h2>
                </div>
                <button onclick="copyFullCode()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                    <span class="material-symbols-outlined">content_copy</span> Copy
                </button>
            </div>
            <div id="code-viewer" class="code-block h-[50vh] text-xs">Loading...</div>
        </div>
    </section>

</main>

<!-- MOBILE BOTTOM NAV -->
<nav class="fixed bottom-0 left-0 right-0 z-50 bg-gray-900/95 backdrop-blur-xl border-t border-white/10 pb-safe md:hidden shadow-[0_-4px_20px_rgba(0,0,0,0.5)]">
    <div class="flex justify-around items-center h-16 px-2">
        <button onclick="switchTab('mental')" class="nav-item flex flex-col items-center justify-center w-16 h-full text-gray-400 transition-colors" id="nav-mental">
            <span class="material-symbols-outlined text-2xl mb-0.5">psychology_alt</span>
            <span class="text-[10px] font-bold">Mind</span>
        </button>
        <button onclick="switchTab('hubs')" class="nav-item flex flex-col items-center justify-center w-16 h-full text-gray-400 transition-colors" id="nav-hubs">
            <span class="material-symbols-outlined text-2xl mb-0.5">public</span>
            <span class="text-[10px] font-bold">World</span>
        </button>
        <button onclick="switchTab('menu')" class="nav-item flex flex-col items-center justify-center w-16 h-full text-gray-400 transition-colors" id="nav-menu">
            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center shadow-lg transform -translate-y-3 border-4 border-gray-900">
                <span class="material-symbols-outlined text-white text-xl">home</span>
            </div>
        </button>
        <button onclick="switchTab('missions')" class="nav-item flex flex-col items-center justify-center w-16 h-full text-gray-400 transition-colors" id="nav-missions">
            <span class="material-symbols-outlined text-2xl mb-0.5">assignment</span>
            <span class="text-[10px] font-bold">Tasks</span>
        </button>
        <button onclick="switchTab('ottomatic')" class="nav-item flex flex-col items-center justify-center w-16 h-full text-gray-400 transition-colors" id="nav-ottomatic">
            <span class="material-symbols-outlined text-2xl mb-0.5">shopping_bag</span>
            <span class="text-[10px] font-bold">Store</span>
        </button>
    </div>
</nav>

<!-- Detail Modal (Bottom Sheet on Mobile, Modal on Desktop) -->
<div id="detail-modal" class="fixed inset-0 z-[60] hidden flex items-end md:items-center justify-center sm:px-4">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop" onclick="closeModal()"></div>
    
    <!-- Modal Content -->
    <div id="modal-content" class="bg-gray-900 w-full md:max-w-4xl max-h-[85vh] md:max-h-[90vh] rounded-t-3xl md:rounded-3xl shadow-2xl border-t border-l border-r md:border-4 border-gray-700 flex flex-col relative overflow-hidden transform transition-transform translate-y-full md:translate-y-0 md:scale-95 md:opacity-0">
        
        <!-- Pull Indicator for Mobile -->
        <div class="md:hidden w-full flex justify-center pt-3 pb-1 absolute top-0 z-20 pointer-events-none">
            <div class="w-12 h-1.5 bg-white/20 rounded-full"></div>
        </div>

        <!-- Header -->
        <div class="relative h-32 md:h-56 w-full flex-shrink-0 overflow-hidden bg-gray-800" id="modal-header-bg">
            <img id="modal-img" src="" class="w-full h-full object-cover opacity-60">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent"></div>
            
            <button class="absolute top-4 right-4 bg-black/50 hover:bg-white/20 rounded-full p-2 text-white transition z-20 hidden md:block" onclick="closeModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
            
            <div class="absolute bottom-4 left-6 z-10 pr-4">
                <h2 class="text-3xl md:text-5xl text-white drop-shadow-lg psy-font tracking-wide leading-none" id="modal-title">Level Name</h2>
                <div class="flex items-center gap-3 mt-1">
                    <p id="modal-subtitle" class="font-bold text-sm md:text-lg uppercase tracking-widest text-gray-300">Type</p>
                    <span id="modal-percent" class="px-2 py-0.5 bg-black/50 rounded text-xs md:text-sm font-bold border border-white/20">0%</span>
                </div>
            </div>
        </div>
        
        <!-- Body -->
        <div id="modal-body" class="flex-grow overflow-y-auto p-4 md:p-6 custom-scrollbar bg-gray-900 pb-10 md:pb-6">
            <!-- Injected -->
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

    // --- Data ---

    const mentalWorlds = [
        { id: 'loboto', name: "Loboto's Labyrinth", color: "pink", image: "Images/Loboto's_Labyrinth.png", max: { figments: 80, baggage: 5, nuggets: 2, vaults: 2, hams: 0 } },
        { id: 'classroom', name: "Hollis' Classroom", color: "green", image: "Images/Holli's_Classroom.png", max: { figments: 42, baggage: 2, nuggets: 3, vaults: 1, hams: 2 } },
        { id: 'hotstreak', name: "Hollis' Hot Streak", color: "yellow", image: "Images/Holli's_Hot_Streak.png", max: { figments: 106, baggage: 3, nuggets: 4, vaults: 1, hams: 4 } },
        { id: 'compton', name: "Compton's Cookoff", color: "orange", image: "Images/Compton's_Cookoff.png", max: { figments: 51, baggage: 5, nuggets: 2, vaults: 2, hams: 2 } },
        { id: 'sensorium', name: "PSI King's Sensorium", color: "purple", image: "Images/Psi_King's_Sensorium.png", max: { figments: 263, baggage: 5, nuggets: 3, vaults: 2, hams: 4 } },
        { id: 'ford', name: "Ford's Follicles", color: "gray", image: "Images/Ford's_Follicles.png", max: { figments: 26, baggage: 1, nuggets: 1, vaults: 0, hams: 1 } },
        { id: 'strike', name: "Strike City", color: "blue", image: "Images/Strike_City.png", max: { figments: 52, baggage: 2, nuggets: 1, vaults: 1, hams: 1 } },
        { id: 'cruller', name: "Cruller's Correspondence", color: "teal", image: "Images/Cruller's_Correspondence.png", max: { figments: 14, baggage: 1, nuggets: 1, vaults: 1, hams: 0 } },
        { id: 'shark', name: "Tomb of the Sharkophagus", color: "teal", image: "Images/Tomb_Of_Sharkophagus.png", max: { figments: 16, baggage: 0, nuggets: 1, vaults: 1, hams: 1 } },
        { id: 'bob', name: "Bob's Bottles", color: "cyan", image: "Images/Bob's_Bottles.png", max: { figments: 165, baggage: 5, nuggets: 2, vaults: 2, hams: 2 } },
        { id: 'cassie', name: "Cassie's Collection", color: "yellow", image: "Images/Cassie's_Collection.png", max: { figments: 200, baggage: 5, nuggets: 2, vaults: 2, hams: 2 } },
        { id: 'lucrecia', name: "Lucrecia's Lament", color: "indigo", image: "Images/Lucrecia's_Lament.png", max: { figments: 30, baggage: 5, nuggets: 1, vaults: 1, hams: 0 } },
        { id: 'fatherland', name: "Fatherland Follies", color: "red", image: "Images/Fatherland_Follies.png", max: { figments: 90, baggage: 5, nuggets: 2, vaults: 2, hams: 0 } }
    ];

    const hubWorlds = [
        { id: 'motherlobe', name: "The Motherlobe", color: "yellow", image: "Images/The_Motherlobe.png", max: { psiCards: 27, supplyChests: 6, markers: 8 } },
        { id: 'quarry', name: "The Quarry", color: "blue", image: "Images/The_Quarry.png", max: { psiCards: 18, supplyChests: 4, markers: 5 } },
        { id: 'qa', name: "Questionable Area", color: "green", image: "Images/Questionable_Area.png", max: { psiCards: 27, supplyChests: 4, markers: 6 } },
        { id: 'gng', name: "Green Needle Gulch", color: "purple", image: "Images/Green_Needle_Gulch.png", max: { psiCards: 27, supplyChests: 2, markers: 4 } }
    ];

    const pinsData = [
        { name: "Sapphire Lev Ball", type: "Levitation", cost: 10, rank: 1, desc: "Soothing blue levitation ball." },
        { name: "Emerald Lev Ball", type: "Levitation", cost: 10, rank: 1, desc: "Natural green levitation ball." },
        { name: "Ruby Lev Ball", type: "Levitation", cost: 10, rank: 1, desc: "Rubious red levitation ball." },
        { name: "Cannonball", type: "Levitation", cost: 100, rank: 12, desc: "Smash lev ball to the ground." },
        { name: "Food For Thought", type: "Combat", cost: 200, rank: 18, desc: "Nodes restore mental energy." },
        { name: "Heavy Thoughts", type: "Combat", cost: 200, rank: 28, desc: "Anchor enemies in place." },
        { name: "Mental Tax", type: "Utility", cost: 200, rank: 40, desc: "Connections emit Psitantium." },
        { name: "Brain Drain", type: "Combat", cost: 400, rank: 56, desc: "Deplete enemy health via connection." },
        { name: "Fever Reducer", type: "Utility", cost: 200, rank: 14, desc: "Fire hurts less." },
        { name: "Goonade", type: "Combat", cost: 200, rank: 24, desc: "Doubts explode on death." },
        { name: "Beastmastery", type: "Utility", cost: 50, rank: 1, desc: "Pet animals with TK." },
        { name: "Plucky", type: "Combat", cost: 400, rank: 1, desc: "Pluck debris from ground." },
        { name: "Power Nap", type: "Combat", cost: 200, rank: 1, desc: "Longer stun duration." },
        { name: "Stun Gun", type: "Combat", cost: 100, rank: 1, desc: "PSI Blast stuns instead of damage." },
        { name: "Censory Overload", type: "Combat", cost: 500, rank: 32, desc: "More damage to Censors." },
        { name: "Chain Grain", type: "Combat", cost: 500, rank: 36, desc: "Extra blast chains." },
        { name: "Mental Block", type: "Utility", cost: 50, rank: 1, desc: "Longer Brain Block." },
        { name: "Speed Reader", type: "Utility", cost: 100, rank: 10, desc: "Faster Clairvoyance." },
        { name: "Time Warp", type: "Combat", cost: 400, rank: 36, desc: "Speeds up objects." },
        { name: "Bubble Wrap", type: "Combat", cost: 400, rank: 36, desc: "Bigger time bubble." },
        { name: "Bobby Pin", type: "Utility", cost: 50, rank: 1, desc: "Dance when idle." },
        { name: "Mental Magnet", type: "Utility", cost: 200, rank: 8, desc: "Increased pickup range." },
        { name: "Goo Proof", type: "Utility", cost: 200, rank: 22, desc: "No slow from goo." },
        { name: "Glass Cannon", type: "Combat", cost: 200, rank: 24, desc: "Deal more, take more dmg." },
        { name: "VIP Discount", type: "Utility", cost: 750, rank: 50, desc: "Store items cost less." },
        { name: "Psimultanium", type: "Utility", cost: 750, rank: 52, desc: "Double Psitanium drops." },
        { name: "Gag Order", type: "Utility", cost: 400, rank: 30, desc: "Muffles your Archetype." },
        { name: "Pixel Pal", type: "Utility", cost: 400, rank: 32, desc: "Retro Archetype look." },
        { name: "PSI Clone", type: "Utility", cost: 400, rank: 40, desc: "Archetype moves fast." },
        { name: "Wastepaper", type: "Combat", cost: 500, rank: 48, desc: "Archetype explodes on death." },
        { name: "Rainblows", type: "Combat", cost: 300, rank: 12, desc: "Rainbow punch effects." },
        { name: "Strike-onaut", type: "Combat", cost: 600, rank: 48, desc: "Stronger punches." },
        { name: "Mental Check", type: "Utility", cost: 50, rank: 5, desc: "Basic health check." } 
    ];

    const scavengerHuntItems = [
        "Day Old Sushi (Motherlobe)", "Deck of Cards (Motherlobe)", "Enemy Surveillance Device (Motherlobe)", 
        "Psychonauts Name Plaque (Motherlobe)", "Astronaut Ice Cream (Motherlobe)", 
        "Psitanium Knife (Quarry)", "Agent Orientation Laserdisc (Quarry)", "Unexploded Bomb (Quarry)",
        "Novelty Mug (Questionable Area)", "Human Skull (Questionable Area)", "Switchblade Hatchet (Questionable Area)", "Can of Corn (Questionable Area)",
        "Beehive Shaped Like My Phone (GNG)", "Mini Murder Bug Bot (GNG)", "Viking Helmet (GNG)", "Signed Copy of Mindswarm (GNG)"
    ];

    const sideQuests = [
        { id: 'queepie', name: "Dance, Baby, Dance", desc: "Find Queepie in 6 locations (Questionable Area).", max: 6 },
        { id: 'gisu', name: "Good Vibes Only", desc: "Find & repair 3 Psychoseismometers (Quarry, QA x2).", max: 3 },
        { id: 'fungus', name: "A Fungus Among Us", desc: "Find the fungus for Lili (Questionable Area behind waterfall).", max: 1 },
        { id: 'dion', name: "Family is in Tents", desc: "Help Dion set up the Aquatodome (Questionable Area).", max: 1 },
        { id: 'norma', name: "Keep Your Shirt On", desc: "Return all 16 Scavenger Hunt items to Norma.", max: 1 }
    ];

    const miscTasks = [
        { id: 'punch', name: "I LOVE PUNCHING!", desc: "Beat the punching mini-game in Basic Braining (Section 1)." },
        { id: 'rank102', name: "Unlimited Power!", desc: "Reach Rank 102 (Requires all collectibles)." },
        { id: 'gramophone', name: "Make It Stop!", desc: "Break 3 Gramophones in Fatherland Follies." }
    ];

    // --- State Management ---
    let userState = {
        mental: {},
        hubs: {},
        scavenger: [],
        quests: {},
        pins: [],
        misc: []
    };

    // --- Default Data Helper ---
    function getDefaults() {
        const def = { mental: {}, hubs: {}, scavenger: [], quests: {}, pins: [], misc: [] };
        mentalWorlds.forEach(l => { def.mental[l.id] = { figments: 0, baggage: 0, nuggets: 0, vaults: 0, hams: 0 }; });
        hubWorlds.forEach(h => { def.hubs[h.id] = { psiCards: 0, supplyChests: 0, markers: 0 }; });
        sideQuests.forEach(q => { def.quests[q.id] = 0; });
        return def;
    }

    // --- Firebase Integration ---
    const firebaseConfig = {
        apiKey: "AIzaSyCX2K1qLYZFkS-KamEOl3XRWPsjUCPTQOk",
        authDomain: "razz-1a47b.firebaseapp.com",
        projectId: "razz-1a47b",
        storageBucket: "razz-1a47b.firebasestorage.app",
        messagingSenderId: "770722102468",
        appId: "1:770722102468:web:0bec79747368441c20dd91",
        measurementId: "G-Z3K4G4QP98"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'razz-1a47b';
    
    // Universal ID
    const UNIVERSAL_SAVE_ID = 'universal_shared_save_file';
    
    let currentUser = null;
    let saveTimeout = null;

    async function initAuth() {
        document.getElementById('auth-status').innerText = "Connecting to Universal Mind...";
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    // --- Persistence Logic ---
    function saveData() {
        if (!currentUser) return;
        if (saveTimeout) clearTimeout(saveTimeout);
        
        saveTimeout = setTimeout(async () => {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', UNIVERSAL_SAVE_ID, 'user_progress', 'progress');
                await setDoc(docRef, userState, { merge: true });
            } catch (e) {
                console.error("Save failed", e);
            }
        }, 1000); 
    }

    // --- Initialization ---
    async function init() {
        userState = getDefaults();
        renderMentalGrid();
        renderHubGrid();
        renderMissions();
        renderPins();
        
        try {
            await initAuth();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-status').innerText = "Syncing Universal Mind...";
                    
                    const docRef = doc(db, 'artifacts', appId, 'users', UNIVERSAL_SAVE_ID, 'user_progress', 'progress');
                    
                    onSnapshot(docRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const cloudData = snapshot.data();
                            userState.scavenger = cloudData.scavenger || [];
                            userState.pins = cloudData.pins || [];
                            userState.misc = cloudData.misc || [];
                            
                            if(cloudData.mental) {
                                Object.keys(userState.mental).forEach(k => {
                                    if(cloudData.mental[k]) userState.mental[k] = cloudData.mental[k];
                                });
                            }
                            if(cloudData.hubs) {
                                Object.keys(userState.hubs).forEach(k => {
                                    if(cloudData.hubs[k]) userState.hubs[k] = cloudData.hubs[k];
                                });
                            }
                            if(cloudData.quests) {
                                Object.keys(userState.quests).forEach(k => {
                                    if(typeof cloudData.quests[k] !== 'undefined') userState.quests[k] = cloudData.quests[k];
                                });
                            }
                        } 
                        
                        // Refresh UI
                        renderMentalGrid();
                        renderHubGrid();
                        renderMissions();
                        renderPins();
                        updateGlobalStats();
                        if (currentModalData) renderModalBody(); 

                        // Hide loader
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                    }, (error) => {
                        console.error("Sync error", error);
                        document.getElementById('auth-status').innerText = "Sync Failed";
                    });
                }
            });
        } catch (e) {
            document.getElementById('auth-status').innerText = "Offline Mode";
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
        }

        switchTab('menu');
    }

    // --- Logic: Global Stats & Rank ---
    function updateGlobalStats() {
        let rankPoints = 0;
        let totalCompletionVal = 0;
        let totalMaxVal = 0;

        mentalWorlds.forEach(l => {
            const s = userState.mental[l.id];
            const m = l.max;
            rankPoints += (s.figments / 100) + (s.nuggets) + (s.vaults) + (s.baggage * 0.2); 
            
            const wCurrent = s.figments + (s.baggage * 5) + (s.nuggets * 10) + (s.vaults * 10) + (s.hams * 5);
            const wMax = m.figments + (m.baggage * 5) + (m.nuggets * 10) + (m.vaults * 10) + (m.hams * 5);
            totalCompletionVal += wCurrent;
            totalMaxVal += wMax;
        });

        let totalCards = 0;
        hubWorlds.forEach(h => {
            const s = userState.hubs[h.id];
            const m = h.max;
            totalCards += s.psiCards;
            rankPoints += s.markers;
            
            const hCurrent = s.psiCards + (s.supplyChests * 5) + (s.markers * 10);
            const hMax = m.psiCards + (m.supplyChests * 5) + (m.markers * 10);
            totalCompletionVal += hCurrent;
            totalMaxVal += hMax;
        });
        
        rankPoints += Math.floor(totalCards / 9);

        rankPoints += (userState.scavenger.length / 2);
        totalCompletionVal += userState.scavenger.length * 5;
        totalMaxVal += scavengerHuntItems.length * 5;

        sideQuests.forEach(q => {
            const qVal = userState.quests[q.id];
            rankPoints += qVal;
            totalCompletionVal += qVal * 10;
            totalMaxVal += q.max * 10;
        });
        
        totalCompletionVal += userState.pins.length * 5;
        totalMaxVal += pinsData.length * 5;
        totalCompletionVal += userState.misc.length * 10;
        totalMaxVal += miscTasks.length * 10;

        const finalRank = Math.floor(rankPoints) + 1;
        const percent = totalMaxVal > 0 ? Math.floor((totalCompletionVal / totalMaxVal) * 100) : 0;

        document.getElementById('current-rank').innerText = Math.min(finalRank, 102);
        document.getElementById('global-percent').innerText = `${Math.min(percent, 100)}%`;
        
        const titles = ["Intern", "Junior", "Agent", "Senior", "Special", "Head"];
        const tIdx = Math.min(Math.floor(finalRank / 20), titles.length - 1);
        document.getElementById('rank-title').innerText = titles[tIdx];
    }

    // --- Logic: Rendering Grids ---
    
    function renderMentalGrid() {
        const grid = document.getElementById('mental-grid');
        grid.innerHTML = mentalWorlds.map(l => createCard(l, 'mental')).join('');
    }

    function renderHubGrid() {
        const grid = document.getElementById('hubs-grid');
        grid.innerHTML = hubWorlds.map(l => createCard(l, 'hub')).join('');
    }

    function createCard(data, type) {
        const s = type === 'mental' ? userState.mental[data.id] : userState.hubs[data.id];
        const m = data.max;
        
        let maxP = 0, currP = 0;
        if (type === 'mental') {
            maxP = m.figments + m.baggage + m.nuggets + m.vaults + m.hams;
            currP = s.figments + s.baggage + s.nuggets + s.vaults + s.hams;
        } else {
            maxP = m.psiCards + m.supplyChests + m.markers;
            currP = s.psiCards + s.supplyChests + s.markers;
        }
        const pct = maxP === 0 ? 100 : Math.floor((currP / maxP) * 100);
        const isDone = pct >= 100;

        return `
            <div onclick="openModal('${data.id}', '${type}')" class="skew-card relative h-24 md:h-64 rounded-xl md:rounded-2xl overflow-hidden cursor-pointer shadow-lg group bg-gray-800 border ${isDone ? 'border-green-500' : 'border-gray-700'} hover:border-${data.color}-400 active:scale-95">
                <div class="absolute inset-0">
                    <img src="${data.image}" class="w-full h-full object-cover group-hover:scale-110 transition-all duration-700" alt="${data.name}">
                    <div class="absolute inset-0 bg-gradient-to-r from-gray-900 via-gray-900/60 to-transparent md:bg-gradient-to-t md:from-gray-900 md:via-transparent md:to-transparent"></div>
                </div>
                <div class="absolute inset-0 p-3 md:p-4 flex flex-row md:flex-col justify-between items-center md:items-stretch">
                    <div class="flex-grow flex flex-col justify-center md:justify-end">
                         <div class="md:mt-auto">
                             <p class="text-[10px] font-bold uppercase text-gray-400 tracking-widest hidden md:block">${type === 'mental' ? 'Brain' : 'Location'}</p>
                            <h3 class="text-lg md:text-2xl text-white psy-font leading-none mb-1 group-hover:text-${data.color}-400 transition-colors">${data.name}</h3>
                            <div class="w-24 md:w-full bg-gray-700 h-1 md:h-1.5 rounded-full mt-1 md:mt-2 overflow-hidden">
                                <div class="h-full bg-${data.color}-500" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="md:absolute md:bottom-4 md:right-4 flex flex-col items-end justify-center pl-4">
                        <span class="text-xl md:text-2xl font-bold ${isDone ? 'text-green-400' : 'text-white'} psy-font">${pct}%</span>
                        ${isDone ? '<span class="material-symbols-outlined text-green-500 md:hidden">check_circle</span>' : ''}
                    </div>
                </div>
                ${isDone ? '<div class="hidden md:block absolute top-3 right-3 bg-green-500 text-black text-xs font-bold px-2 py-1 rounded transform rotate-3 shadow-lg">COMPLETE</div>' : ''}
            </div>
        `;
    }

    // --- Logic: Missions ---
    
    function renderMissions() {
        // Scavenger Hunt
        const scavList = document.getElementById('scavenger-list');
        scavList.innerHTML = scavengerHuntItems.map((item, idx) => {
            const checked = userState.scavenger.includes(idx);
            return `
                <label class="flex items-center p-3 bg-gray-900/50 rounded-xl cursor-pointer hover:bg-gray-700/50 transition border border-gray-700 border-l-4 border-l-yellow-500 active:bg-gray-800">
                    <input type="checkbox" class="mission-checkbox w-6 h-6 rounded border-gray-600 text-yellow-500 focus:ring-yellow-500 bg-gray-800" 
                        ${checked ? 'checked' : ''} onchange="toggleScavenger(${idx})">
                    <div class="ml-3 text-sm text-gray-200 font-medium select-none flex-grow">${item}</div>
                </label>
            `;
        }).join('');
        document.getElementById('scavenger-progress').innerText = `${userState.scavenger.length}/${scavengerHuntItems.length}`;

        // Side Quests
        const questList = document.getElementById('side-quests-list');
        questList.innerHTML = sideQuests.map(q => {
            const current = userState.quests[q.id];
            const isDone = current === q.max;
            
            let steps = '';
            for(let i=0; i<q.max; i++) {
                steps += `<div class="w-8 h-8 md:w-6 md:h-6 rounded-full border-2 ${i < current ? 'bg-purple-500 border-purple-500' : 'bg-transparent border-gray-600'} flex items-center justify-center transition-all cursor-pointer active:scale-95" onclick="setQuest('${q.id}', ${i+1})">
                    ${i < current ? '<span class="material-symbols-outlined text-sm text-white">check</span>' : ''}
                </div>`;
            }

            return `
                <div class="flex flex-col md:flex-row md:items-center justify-between bg-gray-900/50 p-4 rounded-xl border border-gray-700 gap-3">
                    <div>
                        <h3 class="text-base md:text-lg font-bold text-white ${isDone ? 'text-green-400 line-through' : ''}">${q.name}</h3>
                        <p class="text-xs md:text-sm text-gray-400">${q.desc}</p>
                    </div>
                    <div class="flex gap-2 mt-2 md:mt-0">
                        ${steps}
                        <button class="ml-auto md:ml-2 text-xs text-red-400 p-2" onclick="setQuest('${q.id}', 0)">Reset</button>
                    </div>
                </div>
            `;
        }).join('');

        // Misc
        document.getElementById('misc-tasks-list').innerHTML = miscTasks.map(t => `
            <label class="flex items-center p-3 bg-gray-900/50 rounded-xl cursor-pointer hover:bg-gray-700/50 transition border border-gray-700 border-l-4 border-l-blue-500 active:bg-gray-800">
                <input type="checkbox" class="mission-checkbox w-6 h-6 rounded border-gray-600 text-blue-500 focus:ring-blue-500 bg-gray-800" 
                    ${userState.misc.includes(t.id) ? 'checked' : ''} onchange="toggleMisc('${t.id}')">
                <div class="ml-3 text-sm text-gray-200 font-medium select-none">
                    <div class="font-bold">${t.name}</div>
                    <div class="text-xs text-gray-400">${t.desc}</div>
                </div>
            </label>
        `).join('');
    }

    function renderPins() {
        const grid = document.getElementById('pins-grid');
        grid.innerHTML = pinsData.map((pin, idx) => {
            const owned = userState.pins.includes(idx);
            return `
                <div class="pin-card ${owned ? 'owned' : ''} bg-gray-800 rounded-lg border border-gray-700 p-2 flex flex-col items-center text-center cursor-pointer min-h-[120px] justify-between active:scale-95" onclick="togglePin(${idx})">
                    <div class="w-10 h-10 md:w-16 md:h-16 rounded-full bg-gray-900 mb-1 flex items-center justify-center overflow-hidden border border-gray-600 relative shrink-0">
                        <div class="absolute inset-0 bg-${getPinColor(pin.type)}-500/20"></div>
                        <span class="material-symbols-outlined text-xl md:text-3xl text-${getPinColor(pin.type)}-400">${getPinIcon(pin.type)}</span>
                    </div>
                    <h4 class="text-[10px] md:text-sm font-bold text-white leading-tight line-clamp-2">${pin.name}</h4>
                    ${owned ? 
                        '<span class="text-green-400 text-[8px] md:text-xs font-bold">OWNED</span>' : 
                        `<div class="text-[8px] md:text-[10px] text-yellow-500 bg-black/40 px-1 py-0.5 rounded border border-yellow-500/30">
                            ${pin.cost}
                         </div>`
                    }
                </div>
            `;
        }).join('');
        document.getElementById('pins-collected-count').innerText = `${userState.pins.length}/${pinsData.length}`;
    }

    function getPinColor(type) {
        if(type === 'Combat') return 'red';
        if(type === 'Levitation') return 'blue';
        return 'purple';
    }
    function getPinIcon(type) {
        if(type === 'Combat') return 'swords';
        if(type === 'Levitation') return 'flight';
        return 'psychology';
    }

    // --- Expose Functions ---
    window.filterPins = (type) => {
        const cards = document.getElementById('pins-grid').children;
        pinsData.forEach((pin, idx) => {
            if (type === 'all' || pin.type === type) {
                cards[idx].style.display = 'flex';
            } else {
                cards[idx].style.display = 'none';
            }
        });
    };

    window.togglePin = (idx) => {
        if(userState.pins.includes(idx)) {
            userState.pins = userState.pins.filter(i => i !== idx);
        } else {
            userState.pins.push(idx);
        }
        renderPins();
        updateGlobalStats();
        saveData();
    };

    window.toggleScavenger = (idx) => {
        if(userState.scavenger.includes(idx)) {
            userState.scavenger = userState.scavenger.filter(i => i !== idx);
        } else {
            userState.scavenger.push(idx);
        }
        renderMissions();
        updateGlobalStats();
        saveData();
    };

    window.toggleMisc = (id) => {
        if(userState.misc.includes(id)) userState.misc = userState.misc.filter(i => i !== id);
        else userState.misc.push(id);
        renderMissions(); updateGlobalStats();
        saveData();
    };

    window.setQuest = (id, val) => {
        const cur = userState.quests[id];
        if (val === cur) {
            userState.quests[id] = val - 1; 
        } else {
            userState.quests[id] = val;
        }
        renderMissions();
        updateGlobalStats();
        saveData();
    };

    // --- Logic: Modals ---

    let currentModalData = null;
    let currentModalType = null;

    window.openModal = (id, type) => {
        currentModalType = type;
        const data = type === 'mental' ? mentalWorlds.find(x => x.id === id) : hubWorlds.find(x => x.id === id);
        currentModalData = data;
        
        const modal = document.getElementById('detail-modal');
        const content = document.getElementById('modal-content');
        const backdrop = document.getElementById('modal-backdrop');
        
        modal.classList.remove('hidden');
        
        // Trigger animations (Bottom sheet slide for mobile, Fade/Scale for desktop)
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            content.classList.remove('translate-y-full', 'md:scale-95', 'md:opacity-0');
            content.classList.add('translate-y-0', 'md:scale-100', 'md:opacity-100');
        });
        
        document.getElementById('modal-title').innerText = data.name;
        document.getElementById('modal-subtitle').innerText = type === 'mental' ? 'Mental World' : 'Hub Location';
        document.getElementById('modal-img').src = data.image;
        
        // Apply border color
        content.style.borderColor = `var(--psy-${data.color})`;

        renderModalBody();
    };

    function renderModalBody() {
        const id = currentModalData.id;
        const m = currentModalData.max;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        const container = document.getElementById('modal-body');

        let contentHtml = '';

        if (currentModalType === 'mental') {
            contentHtml += createTrackerRow('Figments', 'gesture', 'pink', s.figments, m.figments, 'figments', true);
            contentHtml += createTrackerRow('Emotional Baggage', 'shopping_bag', 'blue', s.baggage, m.baggage, 'baggage');
            contentHtml += createTrackerRow('Nuggets of Wisdom', 'hotel_class', 'yellow', s.nuggets, m.nuggets, 'nuggets');
            contentHtml += createTrackerRow('Memory Vaults', 'lock_open', 'green', s.vaults, m.vaults, 'vaults');
            contentHtml += createTrackerRow('Half-A-Minds', 'psychology_alt', 'purple', s.hams, m.hams, 'hams');
        } else {
            contentHtml += createTrackerRow('PSI Cards', 'style', 'cyan', s.psiCards, m.psiCards, 'psiCards', true); 
            contentHtml += createTrackerRow('Supply Chests', 'inventory_2', 'orange', s.supplyChests, m.supplyChests, 'supplyChests');
            contentHtml += createTrackerRow('PSI Challenge Markers', 'share_location', 'red', s.markers, m.markers, 'markers');
        }

        container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">${contentHtml}</div>`;
        
        let maxP = 0, currP = 0;
        if (currentModalType === 'mental') {
            maxP = m.figments + m.baggage + m.nuggets + m.vaults + m.hams;
            currP = s.figments + s.baggage + s.nuggets + s.vaults + s.hams;
        } else {
            maxP = m.psiCards + m.supplyChests + m.markers;
            currP = s.psiCards + s.supplyChests + s.markers;
        }
        const pct = maxP === 0 ? 100 : Math.floor((currP / maxP) * 100);
        document.getElementById('modal-percent').innerText = `${pct}%`;
    }

    function createTrackerRow(title, icon, color, current, max, key, isSlider = false) {
        if (max === 0) return ''; 
        
        let controls = '';
        if (isSlider) {
            controls = `
                <div class="flex items-center gap-3 md:gap-4 bg-gray-800 rounded-lg p-2 mt-2">
                    <button onclick="updateVal('${key}', -1)" class="w-10 h-10 md:w-10 md:h-10 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold shadow active:scale-95">-</button>
                    <div class="flex-grow relative h-3 md:h-4 bg-gray-700 rounded-full overflow-hidden">
                         <div class="absolute top-0 left-0 h-full bg-${color}-500 transition-all duration-300" style="width: ${(current/max)*100}%"></div>
                    </div>
                    <button onclick="updateVal('${key}', 1)" class="w-10 h-10 md:w-10 md:h-10 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold shadow active:scale-95">+</button>
                </div>
            `;
        } else {
            let checks = '';
            for(let i=0; i<max; i++) {
                const isActive = i < current;
                checks += `<button onclick="setVal('${key}', ${isActive && i === current-1 ? i : i+1})" class="w-10 h-10 rounded-full border-2 ${isActive ? `bg-${color}-500 border-${color}-400 text-black` : 'bg-gray-800 border-gray-600 text-gray-600'} flex items-center justify-center transition-all active:scale-90">
                    <span class="material-symbols-outlined text-lg">${icon}</span>
                </button>`;
            }
            controls = `<div class="flex flex-wrap gap-2 mt-2">${checks}</div>`;
        }

        return `
            <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-3 md:p-4 hover:border-${color}-500 transition-colors">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2 text-${color}-400">
                        <span class="material-symbols-outlined text-xl">${icon}</span>
                        <span class="font-bold text-sm md:text-lg">${title}</span>
                    </div>
                    <div class="text-xl md:text-2xl psy-font text-white">${current}/${max}</div>
                </div>
                ${controls}
            </div>
        `;
    }

    window.updateVal = (key, delta) => {
        const id = currentModalData.id;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        const max = currentModalData.max[key];
        
        let newVal = s[key] + delta;
        if (newVal < 0) newVal = 0;
        if (newVal > max) newVal = max;
        
        s[key] = newVal;
        renderModalBody(); 
        updateGlobalStats(); 
        saveData();
        if(currentModalType === 'mental') renderMentalGrid(); else renderHubGrid();
    };

    window.setVal = (key, val) => {
        const id = currentModalData.id;
        const s = currentModalType === 'mental' ? userState.mental[id] : userState.hubs[id];
        s[key] = val;
        renderModalBody();
        updateGlobalStats();
        saveData();
        if(currentModalType === 'mental') renderMentalGrid(); else renderHubGrid();
    };

    window.closeModal = () => {
        const content = document.getElementById('modal-content');
        const backdrop = document.getElementById('modal-backdrop');
        
        // Reverse animations
        backdrop.classList.add('opacity-0');
        content.classList.remove('translate-y-0', 'md:scale-100', 'md:opacity-100');
        content.classList.add('translate-y-full', 'md:scale-95', 'md:opacity-0');

        setTimeout(() => {
            document.getElementById('detail-modal').classList.add('hidden');
            currentModalData = null;
        }, 300);
    };

    // --- Tab Switching ---
    window.switchTab = (tab) => {
        // Hide all views
        ['mental', 'hubs', 'missions', 'ottomatic', 'code', 'menu'].forEach(t => {
            const el = document.getElementById(`view-${t}`);
            if (el) el.classList.add('hidden');
            
            // Nav icon update
            const navItem = document.getElementById(`nav-${t}`);
            if(navItem) {
                navItem.classList.remove('text-green-400', 'active');
                navItem.classList.add('text-gray-400');
            }
        });
        
        // Show target view
        const activeView = document.getElementById(`view-${tab}`);
        if (activeView) activeView.classList.remove('hidden');
        
        // Update Nav active state
        const activeNav = document.getElementById(`nav-${tab}`);
        if(activeNav) {
            activeNav.classList.remove('text-gray-400');
            activeNav.classList.add('text-green-400', 'active');
        }
        
        // Scroll to top
        window.scrollTo(0,0);

        if (tab === 'code') renderCode();
    };

    function renderCode() {
        const fullHTML = document.documentElement.outerHTML;
        document.getElementById('code-viewer').innerText = fullHTML;
    }

    window.copyFullCode = () => {
        const code = document.documentElement.outerHTML;
        navigator.clipboard.writeText(code).then(() => {
            alert('Full HTML code copied to clipboard!');
        });
    }

    init();

</script>
</body>
</html>
